<!doctype html><html lang="en"><head><meta charset="UTF-8"><title>Chat Interface</title><link rel="stylesheet" href="34c3f520bd998ee1fd63.css"><script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script><script defer="defer" src="polyfill.js"></script><script defer="defer" src="taskpane.js"></script></head><body><div class="container"><div class="collapsible-container"><button class="collapsible" onclick="toggleSessions()">Previous Chats</button> <button class="new-session-btn" onclick="promptNewSession()">+ New Session</button></div><div class="session-list-container" id="sessionListContainer"><div class="session-list" id="sessionList"></div></div><div class="chat-container"><div class="chat-box" id="chatBox"></div><div class="message-input-container"><input id="messageInput" placeholder="Type your message..."/> <button onclick="sendMessage()">Send</button></div></div></div><main id="app-body" class="ms-welcome__main" style="display:none"><div role="button" id="run"><span class="ms-Button-label">Engage</span></div><p><label id="item-subject"></label></p></main><p><label id="item-subject"></label></p><script>const apiKey="pk_55Z6sjFavFm6nQfw.sk_kZTXgudr2cCvnhdNSBvL5g3U8aQsK6sh",chatBox=document.getElementById("chatBox"),sessionList=document.getElementById("sessionList"),newChatInput=document.getElementById("newChatName");function loadSessions(){fetch("https://api.cloud.sciphi.ai/v3/conversations",{method:"GET",headers:{"x-api-key":apiKey}}).then((e=>e.json())).then((e=>{sessionList.innerHTML="",e.results.forEach((e=>{const s=document.createElement("div");s.classList.add("session-item"),s.textContent=e.name,s.setAttribute("data-session-id",e.id),s.onclick=()=>loadSessionMessages(e.id),sessionList.appendChild(s)})),console.log("‚úÖ All Sessions Loaded with IDs:",[...document.querySelectorAll(".session-item")].map((e=>e.getAttribute("data-session-id"))))}))}let currentSessionId=null;function loadSessionMessages(e){console.log(`üü¢ loadSessionMessages triggered for session ID: ${e}`),currentSessionId=e,document.querySelectorAll(".session-item").forEach((e=>console.log(`Checking session-item: ${e.textContent}, ID: ${e.getAttribute("data-session-id")}`))),document.querySelectorAll(".session-item").forEach((e=>e.classList.remove("active")));const s=Array.from(document.querySelectorAll(".session-item")).find((s=>s.getAttribute("data-session-id")===e));s?(s.classList.add("active"),console.log("‚úÖ Session Highlighted:",e)):console.warn("‚ö†Ô∏è No session item matched this ID:",e),fetch(`https://api.cloud.sciphi.ai/v3/conversations/${e}`,{method:"GET",headers:{"x-api-key":apiKey}}).then((e=>e.json())).then((s=>{if(!s.results||!Array.isArray(s.results))return void console.error("‚ùå ERROR: `results` is missing or not an array.");let t=s.results.map((e=>({role:e.message.role,content:e.message.content,metadata:e.metadata||{}}))).filter((e=>null!==e));t.length?(chatBox.innerHTML="",t.forEach(((e,s)=>{e.content&&processAndDisplayMessage("user"===e.role?"You":"Model Assistant",e.content,e.metadata||{},e.role)}))):console.warn(`‚ö†Ô∏è No messages found in session ${e}.`)})).catch((e=>console.error("‚ùå Error loading session messages:",e)))}function toggleSessions(){const e=document.getElementById("sessionListContainer");e.style.display="none"===e.style.display?"block":"none","block"===e.style.display&&loadSessions()}function addMessageToChat(e,s,t,o){processAndDisplayMessage(e,s,t,o)}function toggleSessions(){const e=document.getElementById("sessionListContainer");e.style.display="none"===e.style.display?"block":"none","block"===e.style.display&&loadSessions()}function sendMessage(){const e=document.getElementById("messageInput"),s=e.value.trim();""!==s&&(addMessageToChat("You",s,{},"user"),fetch("https://api.cloud.sciphi.ai/v3/retrieval/rag_agent",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey},body:JSON.stringify({message:{role:"user",content:s},conversation_id:currentSessionId})}).then((e=>e.json())).then((e=>{console.log("Full API Response:",JSON.stringify(e,null,2)),e.results&&e.results.messages&&e.results.messages.length>0?processAndDisplayMessage("Model Assistant",e.results.messages[0].content,e.results.messages[0].metadata,"assistant"):addMessageToChat("System","No response received from the assistant.",{},"system")})).catch((e=>{console.error("Error sending message:",e),addMessageToChat("System","Error sending message. Please try again.",{},"system")})),e.value="")}function processAndDisplayMessage(e,s,t,o){console.log("üì• Received message:",{sender:e,text:s,metadata:t,role:o});const n=document.createElement("div");let a=s,i=t?.aggregated_search_result?JSON.parse(t.aggregated_search_result):[];if(i=Array.isArray(i)?i:[],a=a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),a=a.replace(/\n/g,"<br>"),console.log("üîç Full metadata object:",t),console.log("üîé Aggregated search results:",i),"assistant"===o&&t?.citations?.length>0){console.log("üîç Citations found:",t.citations);const e=/\[(\d+)\](?!\()/g;let s=t.citations;a=a.replace(e,((e,t)=>{t=parseInt(t),console.log(`üîé Checking for citation index: ${t}`);let o=s.find((e=>e.index===t));if(!o)return console.warn(`‚ö†Ô∏è No matching citation found for index: [${t}]`),e;let n=o.document_id||(o.metadata?.document?.id??null);if(!n&&o.metadata?.associated_query){let e=o.metadata.associated_query;console.log(`üìå Checking aggregated search for associated_query: ${e}`);let s=i.find((s=>s.result?.metadata?.associated_query===e));s&&(n=s.result.document_id,console.log(`‚úÖ Extracted document_id from associated query: ${n}`))}if(!n){let e=i.find((e=>e.result?.document_id))?.result?.document_id;e&&(console.log(`üîª Falling back to first document_id found in aggregated results: ${e}`),n=e)}return n?`<button class="button-30" role="button" onclick="downloadDocument('${n}')">${t}</button>`:(console.warn(`‚ö†Ô∏è No valid document ID found for citation index: [${t}]`),e)})),console.log("üìú Final formatted text:",a)}else console.warn("‚ö†Ô∏è No citations found in metadata.");const r=document.createElement("pre");r.innerHTML=`${e}:<br>${a}`,r.style.whiteSpace="pre-wrap",r.style.wordWrap="break-word",r.style.padding="10px",r.style.backgroundColor="#f4f4f4",r.style.borderRadius="5px",n.appendChild(r),chatBox.appendChild(n),chatBox.scrollTop=chatBox.scrollHeight}function downloadDocument(e){fetch(`https://api.cloud.sciphi.ai/v3/documents/${e}/download`,{method:"GET",headers:{"x-api-key":apiKey}}).then((e=>{if(e.ok)return e.blob();throw new Error("Failed to download document")})).then((s=>{const t=URL.createObjectURL(s),o=document.createElement("a");o.href=t,o.download=`document_${e}.pdf`,document.body.appendChild(o),o.click(),document.body.removeChild(o)})).catch((e=>console.error("Download error:",e)))}function createNewChat(e,s){fetch("https://api.cloud.sciphi.ai/v3/conversations",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey},body:JSON.stringify({name:e})}).then((e=>e.json())).then((s=>{s.results&&s.results.id?(currentSessionId=s.results.id,addMessageToChat("System",`New session "${e}" created. You can start chatting now.`),sendMessage()):alert("Failed to create a new session. Please try again.")})).catch((e=>console.error("Error creating new session:",e)))}function promptNewSession(){const e=prompt("Enter a name for your new chat session:");e&&""!==e.trim()?createNewChat(e):alert("Chat session name cannot be empty.")}document.getElementById("sessionListContainer").style.display="none",document.getElementById("messageInput").addEventListener("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),sendMessage())}))</script><script>document.getElementById("sessionListContainer").style.display="none"</script><script>document.addEventListener("DOMContentLoaded",(function(){console.log("‚úÖ DOM is fully loaded"),Office.onReady((()=>{console.log("‚úÖ Office.js is ready!");const o=document.getElementById("run");o?console.log("‚úÖ Run button found:",o):console.error("‚ö†Ô∏è ERROR: Run button (#run) NOT FOUND. Check if the ID is correct.")}))}))</script></body></html>